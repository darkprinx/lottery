name: Release - promote dev image to production

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Specify the version number bump, norelease does not perform a release."
        required: false
        type: choice
        options:
          - minor
          - major
          - patch
          - norelease

env:
  IMAGE_TAG_DEV: dev
  IMAGE_TAG_PROD: prod

jobs:
  deploy-production:
    name: Promote dev image to production
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Set image name & get commit hash
        id: image-name
        run: |
          echo "IMAGE_NAME=${{ secrets.DOCKERHUB_USER }}/lottery" >> $GITHUB_OUTPUT
          echo "sha-short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Pull existing dev image
        run: |
          docker pull ${{ steps.image-name.outputs.IMAGE_NAME }}:${{ env.IMAGE_TAG_DEV }}

      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
      - name: promote dev image to prod
        run: |
          docker buildx imagetools create \
            --tag ${{ steps.image-name.outputs.IMAGE_NAME }}:${{ env.IMAGE_TAG_PROD }} \
            --tag ${{ steps.image-name.outputs.IMAGE_NAME }}:${{ steps.image-name.outputs.sha-short }} \
            ${{ steps.image-name.outputs.IMAGE_NAME }}:${{ env.IMAGE_TAG_DEV }}

      - name: Trigger CD deployment pipeline
        run: |
          echo "CD deployment pipeline would be triggered here."

      - name: Promotion summary
        run: |
          echo "## ðŸš€ Image Promotion Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **From:** dev" >> $GITHUB_STEP_SUMMARY
          echo "- **To:** prod" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ steps.image-name.outputs.IMAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Fast-forward merge detected on main branch" >> $GITHUB_STEP_SUMMARY




  create-github-release:
    needs: deploy-production
    if: success() && github.event.inputs.version_bump != 'norelease'
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: rymndhng/release-on-push-action@aebba2bbce07a9474bf95e8710e5ee8a9e922fe2 # v0.28.0
        id: release
        with:
          bump_version_scheme: ${{ github.event.inputs.version_bump }}
          use_github_release_notes: true
          tag_prefix: v

